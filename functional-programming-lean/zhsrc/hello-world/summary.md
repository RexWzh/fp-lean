# 概要

## 评估与执行

副作用是程序执行的一些方面，超出了数学表达式的评估范围，例如读取文件，抛出异常或触发工业机械。
虽然大多数语言允许在评估过程中发生副作用，但 Lean 不允许。
相反，Lean 使用一种称为 `IO` 的类型来表示使用副作用的程序的描述。
然后，这些描述由语言的运行时系统执行，该系统调用 Lean 表达式求值器执行特定的计算。
类型为 `IO α` 的值称为 _`IO` 操作_。
最简单的操作是 `pure`，它返回其参数并没有实际的副作用。

`IO` 操作也可以理解为以整个世界作为参数并返回发生副作用后的新世界的函数。
在幕后，`IO` 库确保世界永远不会被复制、创建或销毁。
虽然这种副作用模型实际上无法实现，因为整个宇宙太大而无法放入内存中，但真实世界可以用一个在程序中传递的标记来表示。

当程序开始时，会执行 `IO` 操作 `main`。
`main` 可以有三种类型：
 * `main : IO Unit` 用于无法读取命令行参数且总是返回退出码 `0` 的简单程序，
 * `main : IO UInt32` 用于没有参数的程序，可能会产生成功或失败的信号，以及
 * `main : List String → IO UInt32` 用于接收命令行参数并发出成功或失败信号的程序。


## `do` 表示法

Lean 标准库提供了一些基本的 `IO` 操作，表示读写文件和与标准输入输出交互等效果。
这些基本的 `IO` 操作使用 `do` 表示法组合成更大的 `IO` 操作，`do` 表示法是一种用于编写具有副作用程序描述的内置领域特定语言。
`do` 表达式包含一个序列的 _语句_，可以是：
 * 表示 `IO` 操作的表达式，
 * 使用 `let` 和 `:=` 的普通局部定义，其中定义的名称引用所提供表达式的值，或
 * 使用 `let` 和 `←` 的局部定义，其中定义的名称引用执行所提供表达式的值的结果。

使用 `do` 编写的 `IO` 操作逐条语句执行。
此外，在 `do` 下发生的 `if` 和 `match` 表达式被隐式地认为是在每个分支中都有自己的 `do` 。
在 `do` 表达式内部，*嵌套操作* 是指紧接在括号下方的箭头左侧的表达式。
Lean 编译器会隐式地将它们提升到最近的封闭 `do` ，这可能隐式地是 `match` 或 `if` 表达式的一个分支的一部分，并给它们分配一个唯一的名称。
然后，这个唯一的名称会取代嵌套操作的原始位置。

## 编译和运行程序

一个只包含一个 `main` 定义的 Lean 程序可以使用 `lean --run FILE` 来运行。
尽管这是一个简单程序的好方法，但大多数程序在运行之前都会编译为多个文件的项目。

Lean 项目被组织成_包_，包括库和可执行文件，以及关于依赖项和构建配置的信息。
包使用 Lake 进行描述和构建，Lake 是一个 Lean 的构建工具。
使用 `lake new` 在新目录中创建一个 Lake 包，或者使用 `lake init` 在当前目录中创建一个。
Lake 包配置是另一种领域特定语言。
使用 `lake build` 来构建一个项目。

## 偏函数性质

遵循表达式求值的数学模型的一个结果是，每个表达式都必须有一个值。
这排除了那些未能覆盖数据类型的所有构造函数和可能陷入无限循环的程序的不完整模式匹配。
Lean 确保所有的 `match` 表达式都覆盖到所有的情况，并且所有递归函数要么是结构递归的，要么具有明确的终止证明。

然而，一些真实的程序需要可能无限循环的可能性，因为它们处理潜在的无限数据，比如 POSIX 流。
Lean 提供了一种逃生方式：被标记为 `partial` 的函数不需要终止。
这是有代价的。
因为类型是 Lean 语言的一部分，函数可以返回类型。
但是，部分函数在类型检查期间不会被求值，因为函数中的无限循环可能导致类型检查器进入无限循环。
此外，数学证明无法检查部分函数的定义，这意味着使用这些函数的程序对形式证明的可证性更不友好。